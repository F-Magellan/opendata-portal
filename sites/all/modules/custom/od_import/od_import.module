<?php

/**
 * Define module root directory.
 */
define('OD_IMPORT', dirname(__FILE__));

/**
 * Load constants.
 */
require_once OD_IMPORT . '/includes/constants.inc';

/**
 * Include API files.
 */
require_once OD_IMPORT . '/includes/controller.inc';

/**
 * Implements hook_action_info().
 */
function od_import_action_info() {
  // Init output variable.
  $items = array();

  $items['od_import_import_opendata_action'] = array(
    'type' => 'node',
    'label' => 'Загрузка открытых данных с сайта организации',
    'configurable' => FALSE,
    'aggregate' => TRUE,
    'triggers' => array('any'),
  );

  return $items;
}

/**
 * Action callback. Import opendata from organizations.
 */
function od_import_import_opendata_action($entities) {
  // Include helper opendata parser functions.
  require_once OD_IMPORT . '/' . 'includes/helper/opendata_parser.inc';

  // Check "Opendata API" library.
  $od_library = libraries_load('od_api');
  if (!$od_library['loaded']) {
    $error = 'Библиотека "Opendata API" не установлена.';
    od_log($error, OD_LOG_IMPORTANCE_ERROR, OD_LOG_EVENT_IMPORT_DATA);
    return;
  }

  foreach ($entities as $entity) {
    _od_import_organization_opendata($entity);
  }
}

/**
 * Implements hook_views_api().
 */
function od_import_views_api() {
  // Define views api version.
  $views_api = array(
    'api' => 3,
    'path' => OD_IMPORT . '/includes/views',
  );

  return $views_api;
}

/**
 * Implements hook_views_default_views().
 */
function od_import_views_default_views() {
  // Init output variable.
  $items = array();

  $path = OD_IMPORT . '/includes/views/custom_views';

  foreach (array_keys(file_scan_directory($path, '/\.inc$/')) as $file_path) {
    require $file_path;

    if (isset($view)) {
      $items[$view->name] = $view;
    }
  }

  return $items;
}
